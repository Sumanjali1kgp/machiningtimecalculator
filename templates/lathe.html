<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lathe Operations - IIT Kharagpur</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
</head>

<body>
    <!-- Header Section -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-bar">
                    <img src="{{ url_for('static', filename='images/iitkgp_logo.png') }}" alt="IIT Kharagpur Logo" class="iit-logo">
                    <div class="institute-info">
                        <h1>Central Workshop</h1>
                        <p class="subheading">Indian Institute of Technology Kharagpur | Lathe Operations</p>
                    </div>
                </div>
                <nav class="main-nav">
                    <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                    <a href="#features" class="nav-link">Features</a>
                    <a href="{{ url_for('lathe') }}" class="nav-link active">Lathe</a>
                    <a href="{{ url_for('milling') }}" class="nav-link">Milling</a>
                    <a href="#contact" class="nav-link">Contact</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="container">
            <div class="content-wrapper">
                <h2 class="page-title">Lathe Operation Input</h2>
                <!-- Top Inputs Row -->
                <!-- Input Card -->
            <div class="input-card">
                <div class="form-group">
                    <label for="materialSelect">JOB MATERIAL</label>
                    <select id="materialSelect" class="form-control">
                        <option value="">Select Material</option>
                        <option value="1">Aluminum</option>
                        <option value="2">Brass</option>
                        <option value="3">Copper</option>
                        <option value="4">Stainless Steel</option>
                        <option value="5">Mild Steel</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="operationSelect">SELECT OPERATION</label>
                    <select id="operationSelect" class="form-control">
                        <option value="" disabled selected>--Select Process--</option>
                        <option value="facing">Facing</option>
                        <option value="turning">Turning</option>
                        <option value="drilling">Drilling</option>
                        <option value="boring">Boring</option>
                        <option value="grooving">Grooving</option>
                        <option value="reaming">Reaming</option>
                        <option value="threading">Threading</option>
                        <option value="knurling">Knurling</option>
                        <option value="parting">Parting</option>
                        <option value="idle">Idle Operation</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="addProcessBtn" class="btn-add">
                        <i class="fas fa-plus"></i> Add Process
                    </button>
                </div>
            </div>

            <!-- Operation forms container -->
            <div id="operationFormsContainer" class="operation-container">
                <!-- Operation forms will be dynamically added here -->
            </div>
            <div id="operationList"></div>
                        
                        <!-- Dynamic Parameter Form Container -->
                        <div id="paramForm" class="param-form-container">
                            <!-- Form will be dynamically inserted here by JavaScript -->
                        </div>
                    </div>
                    <!-- Time Section -->
                    <div id="timeSection" class="time-cost-section bg-gray-50 p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200">Time Breakdown</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-all hover:shadow-md">
                                <div class="text-sm font-medium text-gray-500 mb-1">Machining Time</div>
                                <div class="text-lg font-semibold text-blue-600" id="machiningTime" data-total="0">0.00 min</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-all hover:shadow-md">
                                <div class="text-sm font-medium text-gray-500 mb-1">Idle Time</div>
                                <div class="text-lg font-semibold text-yellow-600" id="idleTime" data-total="0">0.00 min</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-all hover:shadow-md">
                                <div class="text-sm font-medium text-gray-500 mb-1">Setup Time</div>
                                <div class="text-lg font-semibold text-green-600" id="setupTime" data-total="0">0.00 min</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-all hover:shadow-md">
                                <div class="text-sm font-medium text-gray-500 mb-1">Tool Change Time</div>
                                <div class="text-lg font-semibold text-purple-600" id="toolTime" data-total="0">0.00 min</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-all hover:shadow-md">
                                <div class="text-sm font-medium text-gray-500 mb-1">Miscellaneous Time</div>
                                <div class="text-lg font-semibold text-pink-600" id="miscTime" data-total="0">0.00 min</div>
                            </div>
                        </div>

                        <!-- Total Time -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-100">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-sm font-medium text-gray-600">TOTAL TIME</div>
                                    <div class="text-3xl font-bold text-gray-800" id="totalTime">0.00 min</div>
                                </div>
                                <div class="text-blue-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- User Input -->
                        <div class="mt-4">
                            <label for="setupTimeInput" class="block text-sm font-medium text-gray-500 mb-2">Setup Time (min)</label>
                            <input type="number" id="setupTimeInput" class="form-input mb-4" step="0.1" min="0" value="0" placeholder="e.g. 5.0" onchange="updateSetupTime()">

                            <label for="toolTimeInput" class="block text-sm font-medium text-gray-500 mb-2">Tool Change or Regrinding Time per Job (min)</label>
                            <input type="number" id="toolTimeInput" class="form-input mb-4" step="0.1" min="0" value="0" placeholder="e.g. 10.5" onchange="updateToolTime()">

                            <label for="miscInput" class="block text-sm font-medium text-gray-500 mb-2">Miscellaneous Time (min)</label>
                            <input type="number" id="miscInput" class="form-input mb-4 w-full" step="0.1" min="0" value="0" placeholder="e.g. 2.5" onchange="updateMiscTime()">
                        </div>
                    </div>

                    <!-- Cost Calculation Button -->
                    </div> <!-- End of operation-form -->
                </div> <!-- End of form-section -->
                
                <div class="button-section">
                    <button type="button" id="calculateTimeBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-clock mr-2"></i> Calculate Total Time
                    </button>
                    <button type="button" id="calculateCostBtn" class="btn" onclick="document.getElementById('calculateCostBtn').click()">
                        <i class="fas fa-calculator"></i> Calculate Total Cost
                    </button>
                </div> <!-- End of button-section -->
            </div> <!-- End of form-container -->
            
           

            <!-- Cost Details Section (Initially Hidden) -->
            <div id="costDetailsSection" class="hidden">
                <!-- Cost Breakdown Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (min)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost (₹)</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Material Cost</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">—</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" id="materialCost">₹0.00</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Setup & Idle Time Cost</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="setupIdleTimeValue">0.00</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" id="setupIdleCost">₹0.00</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Machining Cost</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="machiningTimeValue">0.00</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" id="machiningCost">₹0.00</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Tooling Cost</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="toolingTimeValue">0.00</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" id="toolingCost">₹0.00</td>
                            </tr>
                            <tr class="border-t-2 border-gray-200">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">Total Raw Cost</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">—</td>
                                <td class="px-6 py-4 whitespace-nowrap text-lg font-bold text-gray-900" id="totalRawCost">₹0.00</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Overhead (40%)</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">—</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" id="overheadCost">+ ₹0.00</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">Final Estimated Cost</td>
                                <td class="px-6 py-4 whitespace-nowrap"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-xl font-bold text-blue-700" id="finalCost">₹0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Final Cost Summary -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Total Raw Cost:</span>
                        <span class="text-base font-semibold">₹<span id="totalRawCostSummary">0.00</span></span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Overhead (40%):</span>
                        <span class="text-base font-semibold text-red-600">+ ₹<span id="overheadCostSummary">0.00</span></span>
                    </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t border-gray-200">
                        <span class="text-lg font-bold text-gray-900">Final Estimated Cost:</span>
                        <span class="text-xl font-bold text-blue-700">₹<span id="finalCostSummary">0.00</span></span>
                    </div>
                </div>
            </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="export-options">
                        <div class="export-buttons">
                            <button class="btn btn-export" onclick="exportToPDF('shop')">
                                <i class="fas fa-file-pdf"></i> Export Shop Version
                            </button>
                            <button class="btn btn-export" onclick="exportToPDF('customer')">
                                <i class="fas fa-file-invoice-dollar"></i> Export Customer Version
                            </button>
                            <button class="btn btn-clear" onclick="clearAll()">
                                <i class="fas fa-trash-alt"></i> Clear All
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    <!-- Back to Top Button -->
    <button class="back-to-top" id="backToTop" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Load external JavaScript libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script type="module">
    import { calculateAndDisplayTimes, updateToolTime, updateMiscTime } from '/static/time.js';
    import { calculateAndDisplayCosts } from '/static/cost.js';

    document.addEventListener('DOMContentLoaded', async () => {
        // Toggle sidebar on mobile
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.querySelector('.sidebar');
    
        if (hamburger && sidebar) {
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                sidebar.classList.toggle('active');
            });
    
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 992 && !e.target.closest('.sidebar') && !e.target.closest('.hamburger')) {
                    sidebar.classList.remove('active');
                    hamburger.classList.remove('active');
                }
            });
        }

        // Fetch materials and operations
        await loadMaterials();
        await fetchAndPopulateOperations();

        // Bind global time & cost event handlers
        document.getElementById('toolTimeInput')?.addEventListener('input', updateToolTime);
        document.getElementById('miscInput')?.addEventListener('change', updateMiscTime);
        document.getElementById('calculateTimeBtn')?.addEventListener('click', calculateAndDisplayTimes);
        document.getElementById('calculateCostBtn')?.addEventListener('click', calculateAndDisplayCosts);
    });

    async function loadMaterials() {
        try {
            const response = await fetch('/api/materials');
            if (!response.ok) throw new Error(`Error: ${response.status}`);
            const materials = await response.json();
            const select = document.getElementById('materialSelect');
            select.innerHTML = '<option value="">Select Material</option>';
            materials.forEach(mat => select.add(new Option(mat.material_name, mat.material_id || mat.id)));
        } catch (error) {
            console.error('Error loading materials:', error);
        }
    }

    async function fetchAndPopulateOperations() {
        try {
            const response = await fetch('/api/operations');
            if (!response.ok) throw new Error(`Error: ${response.status}`);
            const operations = await response.json();
            const select = document.getElementById('operationSelect');
            select.innerHTML = '<option value="" disabled selected>--Select Process--</option>';
            operations.forEach(op => select.add(new Option(op.operation_name, op.operation_id)));
            
            // Store operations globally for other scripts
            window.operations = operations.reduce((acc, op) => {
                acc[op.operation_id] = op.operation_name.toLowerCase();
                return acc;
            }, {});
        } catch (error) {
            console.error('Error loading operations:', error);
        }
    }
    </script>
    
    <!-- Load jsPDF and autoTable first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Make jsPDF available globally -->
    <script>
        window.jspdf = window.jspdf || {};
    </script>
    
    <!-- Load all modules in the correct order -->
    <script type="module">
        // Import the export function
        const pdfExportModule = '{{ url_for('static', filename='pdf-export.js') }}';
        const timeModule = '{{ url_for('static', filename='time.js') }}';
        const costModule = '{{ url_for('static', filename='cost.js') }}';
        
        // Function to initialize the application
        async function initializeApp() {
            try {
                // Import modules
                const [pdfExport, time, cost] = await Promise.all([
                    import(pdfExportModule),
                    import(timeModule),
                    import(costModule)
                ]);
                
                console.log('All modules loaded successfully');
                
                // Make functions globally available
                window.exportToPDF = pdfExport.exportToPDF;
                window.calculateAndDisplayTimes = time.calculateAndDisplayTimes;
                window.calculateAndDisplayCosts = cost.calculateAndDisplayCosts;
                window.updateToolTime = time.updateToolTime || function() {};
                window.updateMiscTime = time.updateMiscTime || function() {};
                window.updateSetupTime = time.updateSetupTime || function() {};
                window.calculateOperationTime = time.calculateOperationTime || function() {};
                
                // Show time section by default
                const timeSection = document.getElementById('timeSection');
                if (timeSection) {
                    timeSection.style.display = 'block';
                    timeSection.classList.remove('hidden');
                    console.log('Time section shown');
                }
                
                // Set up event listeners for time inputs
                function setupTimeInputs() {
                    console.log('Setting up time input listeners...');
                    
                    const toolTimeInput = document.getElementById('toolTimeInput');
                    const miscInput = document.getElementById('miscInput');
                    const setupTimeInput = document.getElementById('setupTimeInput');
                    
                    if (toolTimeInput) {
                        toolTimeInput.addEventListener('input', () => {
                            console.log('Tool time input changed');
                            window.updateToolTime();
                            window.calculateAndDisplayTimes();
                        });
                    }
                    
                    if (miscInput) {
                        miscInput.addEventListener('input', () => {
                            console.log('Misc time input changed');
                            window.updateMiscTime();
                            window.calculateAndDisplayTimes();
                        });
                    }
                    
                    if (setupTimeInput) {
                        setupTimeInput.addEventListener('input', () => {
                            console.log('Setup time input changed');
                            window.updateSetupTime();
                            window.calculateAndDisplayTimes();
                        });
                    }
                }
                
                // Initialize time inputs
                setupTimeInputs();
                
                // Initial calculation
                console.log('Performing initial time calculation...');
                if (typeof window.calculateAndDisplayTimes === 'function') {
                    await window.calculateAndDisplayTimes();
                }
                
                // Enable calculate cost button if it exists
                const calculateCostBtn = document.getElementById('calculateCostBtn');
                if (calculateCostBtn) {
                    calculateCostBtn.disabled = false;
                    console.log('Calculate Cost button enabled');
                }
                
            } catch (error) {
                console.error('Error initializing application:', error);
            }
        }
        
        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
    </script>
    
    <!-- Load main application script -->
    <script type="module" src="{{ url_for('static', filename='script.js') }}"></script>
    </script>

  
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2023 IIT Kharagpur. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Scripts are loaded as modules in script.js -->
</body>
</html>